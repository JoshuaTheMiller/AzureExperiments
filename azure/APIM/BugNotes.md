$tenantId="6172d37c-f170-4d52-850d-009052ee1b5a"
$subscriptionId="9f287572-0b8e-4e6e-be2c-a3362e92704f"
$resourceGroupName="joshesapimland-poc-rg"
$plan="joshesapimland-poc-plan"
$appName="joshesapimland-poc-app"
$hybridConnectionNamespaceName="joshesapimland-poc-relay"
$relayName="localhostconnection"

# $body= @{    
#     "name"="localhostconnection"
#     "properties.hostname"="localhost"
#     "properties.port"=8080
#     "properties.relayArmUri"="/subscriptions/9f287572-0b8e-4e6e-be2c-a3362e92704f/resourceGroups/joshesapimland-poc-rg/providers/Microsoft.Relay/namespaces/joshesapimland-poc-relay"
#     "properties.relayName"="joshesapimland-poc-relay"
#     "properties.sendKeyName"="defaultSender"
#     "properties.sendKeyValue"=""
#     "properties.serviceBusNamespace"="joshesapimland-poc-relay"
#     "properties.serviceBusSuffix" = ".servicebus.windows.net"
# }

$what=@{
    
    "properties"=@{
        "relayArmUri"="/subscriptions/9f287572-0b8e-4e6e-be2c-a3362e92704f/resourceGroups/joshesapimland-poc-rg/providers/Microsoft.Relay/namespaces/joshesapimland-poc-relay/hybridConnections/localhostconnection"
        "hostName"="localhost"
        "port"=8080
        "sendKeyName"="defaultSender"
        "sendKeyValue"=""
        "serviceBusSuffix"=".servicebus.windows.net"
    }
}

# How the heck do you get the json string to be string escaped???
# What nonsense is this, that it causes HC to work, whereas using Terraform causes it to fail??
$doubleWhat = ($what | ConvertTo-Json -Compress | ConvertTo-Json )

$body='{"location":"Central US","properties":{"relayArmUri":"/subscriptions/9f287572-0b8e-4e6e-be2c-a3362e92704f/resourceGroups/joshesapimland-poc-rg/providers/Microsoft.Relay/namespaces/joshesapimland-poc-relay/hybridConnections/localhostconnection","hostName":"localhost","port":8080,"sendKeyName":"defaultSender","sendKeyValue":"lolno","serviceBusSuffix":".servicebus.windows.net"}}'

$url = "https://management.azure.com/subscriptions/$subscriptionId/resourceGroups/$resourceGroupName/providers/Microsoft.Web/sites/$appName/hybridConnectionNamespaces/$hybridConnectionNamespaceName/relays/$relayName`?api-version=2018-11-01"

$clientId=""
$clientSecret=""
$jwt = (curl -X POST -d "grant_type=client_credentials&client_id=$clientId&client_secret=$clientSecret&resource=https%3A%2F%2Fmanagement.azure.com%2F" "https://login.microsoftonline.com/$tenantId/oauth2/token" `
    | ConvertFrom-Json).access_token

$requestBody = ($body | ConvertTo-Json -Compress )

$requestBody

# ARM Reference: https://docs.microsoft.com/en-us/azure/templates/microsoft.web/2019-08-01/sites/hybridconnectionnamespaces/relays
# https://medium.com/@mauridb/calling-azure-rest-api-via-curl-eb10a06127
# https://github.com/terraform-providers/terraform-provider-azurerm/blob/master/azurerm/internal/services/web/app_service_hybrid_connection_resource.go

# Creates or updates the App Service Hybrid Connection
az rest -m put --headers Content-type=application/json -u $url -b $doubleWhat
# az rest -m get -u $url

$listKeysUrl="https://management.azure.com/subscriptions/$subscriptionId/resourceGroups/$resourceGroupName/providers/Microsoft.Web/serverfarms/$plan/hybridConnectionNamespaces/$hybridConnectionNamespaceName/relays/$relayName/listKeys?api-version=2019-08-01"
az rest -m post -u $listKeysUrl
# The above call shows that the key Terraform sets is an empty string
# The following shows that SendKeyValue is empty on create: https://github.com/terraform-providers/terraform-provider-azurerm/blob/master/azurerm/internal/services/web/app_service_hybrid_connection_resource.go#L145
# Furthermore, the state that gets created contains the sendKey or default key for the Relay itself, not just the HybridConnection. This can be seen by checking the state file.
# When using the Azure UI, the send key of the hybrid connection itself is used. This can be validated by using the list keys url above (the sendKeyValue is the primary key of the HybridConnection defaultSender policy)
# Looking at the traffic that is generated by the UI, the portal first list the keys of the HybridConnection defaultSender policy (assuming that the portal created the HybridConnection)
# It then uses the Primary key in its call to PUT (create or update) the Hybrid Connection


# WebClient: https://github.com/terraform-providers/terraform-provider-azurerm/blob/master/azurerm/internal/clients/client.go
# AppService client: https://github.com/terraform-providers/terraform-provider-azurerm/blob/master/azurerm/internal/services/web/client/client.go
# Guy with cool name on code: https://github.com/jackofallops

#curl --request PUT --header "Content-Type: application/json" --header "Authorization: Bearer $jwt" --data "${requestBody}"  $url
